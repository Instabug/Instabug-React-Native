version: 2
jobs:
  publish:
    macos:
      xcode: "10.1.0"
    steps:
      - checkout
      # - run: git clone -b react-native --single-branch https://InstabugCI:$RELEASE_GITHUB_TOKEN@github.com/Instabug/Escape.git
      # - run: cd Escape; swift build -c release -Xswiftc -static-stdlib
      # - run: cd Escape/.build/release; cp -f Escape /usr/local/bin/escape
      # - run: Escape react-native publish
  run_sample_app:
    macos:
      xcode: "10.2.0"
    working_directory: ~/project/InstabugSample
    steps:
      - checkout:
          path: ~/project
      - run: yarn install
      - run: yarn global add react-native
      - run: yarn global add react-native-cli
      - run: react-native link instabug-reactnative
      # - run: react-native run-android
      - run: react-native run-ios
      
  run_android_app:
    docker:
      - image: circleci/android:api-28-node
    working_directory: ~/project/InstabugSample/android
    steps:
      - checkout:
          path: ~/project
      - run: cd ..; yarn install
      - run: cd ..; sudo npm install -g react-native
      - run: cd ..; echo 'export PATH="/usr/local/bin:$PATH"' >> $BASH_ENV 
      - run: cd ..; node link_bridge.js
      - run:
          name: Setup emulator
          command: sdkmanager "system-images;android-28;google_apis;x86_64" && echo "no" | avdmanager create avd -n test -k "system-images;android-28;google_apis;x86_64"
      - run:
          name: Launch emulator
          command: export LD_LIBRARY_PATH=${ANDROID_HOME}/emulator/lib64:${ANDROID_HOME}/emulator/lib64/qt/lib && emulator64-arm -avd test -noaudio -no-boot-anim -no-window -accel on
          background: true
      - run:
          name: chmod permissions
          command: chmod +x ./gradlew
      - run:
          name: Build App
          command: ./gradlew assembleDebug
      - run:
          name: Run App
          command: ./gradlew installDebug

workflows:
  version: 2
  publish:
    jobs:
      - run_sample_app
      - run_android_app
      - publish:
          requires:
            - run_android_app